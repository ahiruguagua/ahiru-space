<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ã²ã‚ˆã“ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ãƒãƒˆãƒ«</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'Segoe UI', 'Hiragino Sans', sans-serif;
    overflow: hidden;
    background: #87CEEB;
    user-select: none;
  }
  canvas { display: block; }
  #ui-layer {
    position: absolute; top: 0; left: 0;
    width: 100%; height: 100%;
    pointer-events: none;
  }
  #score-board {
    position: absolute; top: 16px; left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.6); color: #fff;
    padding: 8px 28px; border-radius: 20px;
    font-size: 20px; letter-spacing: 1px; z-index: 10;
  }
  #score-board span { color: #FFD700; font-weight: bold; }
  #combo-display {
    position: absolute; top: 60px; left: 50%;
    transform: translateX(-50%);
    color: #FF6347; font-size: 28px; font-weight: bold;
    text-shadow: 0 0 8px rgba(255,99,71,0.6);
    opacity: 0; transition: opacity 0.3s; z-index: 10;
  }
  #input-box {
    position: absolute; bottom: 30px; left: 50%;
    transform: translateX(-50%);
    pointer-events: auto; z-index: 10;
  }
  #input-box input {
    width: 420px; padding: 12px 20px; font-size: 24px;
    border: 3px solid #FFD700; border-radius: 30px; outline: none;
    text-align: center; background: rgba(255,255,255,0.92);
    box-shadow: 0 4px 15px rgba(0,0,0,0.2); letter-spacing: 2px;
  }
  #input-box input:focus { border-color: #FF6347; }
  #start-screen, #gameover-screen {
    position: absolute; top: 0; left: 0;
    width: 100%; height: 100%;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    background: rgba(0,0,0,0.55);
    z-index: 100; pointer-events: auto;
  }
  #start-screen h1 {
    font-size: 52px; color: #FFD700;
    text-shadow: 3px 3px 0 #c8960a; margin-bottom: 12px;
  }
  #start-screen p { color: #fff; font-size: 18px; margin-bottom: 8px; }
  #start-screen .hint { color: #ccc; font-size: 14px; margin-bottom: 24px; }
  .btn {
    padding: 14px 48px; font-size: 22px; border: none;
    border-radius: 30px; cursor: pointer;
    background: #FFD700; color: #333; font-weight: bold;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    transition: transform 0.15s;
  }
  .btn:hover { transform: scale(1.06); }
  #gameover-screen h2 { font-size: 44px; color: #FF6347; margin-bottom: 10px; }
  #gameover-screen .final-score { font-size: 60px; color: #FFD700; font-weight: bold; margin: 10px 0; }
  #gameover-screen .stats { color: #fff; font-size: 18px; margin-bottom: 24px; line-height: 1.8; }
  #life-bar { position: absolute; top: 16px; right: 20px; font-size: 28px; z-index: 10; }
  #level-display {
    position: absolute; top: 16px; left: 20px;
    background: rgba(0,0,0,0.5); color: #7FFF00;
    padding: 6px 16px; border-radius: 12px; font-size: 16px; z-index: 10;
  }
  .damage-flash { animation: flash 0.3s; }
  @keyframes flash {
    0%, 100% { filter: none; }
    50% { filter: brightness(2) saturate(0); }
  }
  /* Gameover panel */
  #gameover-screen .highscore-entry { margin: 1rem 0; }
  #gameover-screen .highscore-entry p { color: #FFD700; font-weight: 700; margin-bottom: 0.5rem; font-size: 16px; }
  #gameover-screen input[type="text"] {
    width: 280px; padding: 10px 14px; border-radius: 10px;
    border: 2px solid rgba(255,215,0,0.4); background: rgba(255,255,255,0.1);
    color: #fff; font-size: 1rem; font-family: inherit; outline: none; margin-bottom: 0.5rem;
  }
  #gameover-screen input[type="text"]:focus { border-color: #FFD700; }
  #gameover-screen input[type="text"]::placeholder { color: rgba(255,255,255,0.4); }
  .go-btn {
    display: inline-block; padding: 10px 24px; border-radius: 30px;
    border: none; font-size: 1rem; font-weight: bold; cursor: pointer;
    margin: 6px; transition: transform 0.15s; font-family: 'Segoe UI', 'Hiragino Sans', sans-serif;
  }
  .go-btn:active { transform: scale(0.95); }
  .go-btn.primary { background: #FFD700; color: #333; }
  .go-btn.primary:hover { background: #FFE44D; }
  .go-btn.secondary { background: rgba(255,255,255,0.15); color: #fff; border: 1px solid rgba(255,255,255,0.3); }
  .go-btn.secondary:hover { background: rgba(255,255,255,0.25); }
  .submitted-msg { color: #FFD700; font-weight: 700; margin: 0.5rem 0; font-size: 16px; }
  .back-link {
    position: fixed; top: 10px; left: 10px; z-index: 300;
    color: rgba(255,255,255,0.7); text-decoration: none; font-size: 14px;
    font-weight: bold; padding: 4px 12px; background: rgba(0,0,0,0.4);
    border-radius: 20px;
  }
  .back-link:hover { color: #FFD700; }
  /* Leaderboard Overlay */
  .lb-overlay {
    display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    z-index: 200; background: rgba(0,0,0,0.8);
    flex-direction: column; align-items: center; justify-content: center; padding: 20px;
  }
  .lb-overlay.active { display: flex; }
  .lb-panel {
    background: rgba(10,20,40,0.97); border: 2px solid #FFD700; border-radius: 20px;
    padding: 1.5rem; max-width: 400px; width: 100%; max-height: 80vh; overflow-y: auto;
    font-family: 'Segoe UI', 'Hiragino Sans', sans-serif;
  }
  .lb-panel h2 { color: #FFD700; text-align: center; font-size: 1.4rem; margin-bottom: 1rem; }
  .lb-row { display: flex; justify-content: space-between; padding: 6px 8px; color: rgba(255,255,255,0.8); font-size: 0.95rem; }
  .lb-row.top3 { color: #FFD700; font-weight: 700; }
  .lb-row .rank { width: 36px; }
  .lb-row .name { flex: 1; }
  .lb-row .score { text-align: right; }
  .lb-empty { color: rgba(255,255,255,0.5); text-align: center; padding: 2rem; }
</style>
</head>
<body>
<a href="/" class="back-link">&larr; Home</a>
<canvas id="game-canvas"></canvas>
<div id="ui-layer">
  <div id="score-board">SCORE: <span id="score">0</span></div>
  <div id="combo-display"></div>
  <div id="life-bar"></div>
  <div id="level-display">Lv.1</div>
  <div id="input-box">
    <input type="text" id="type-input" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="ã“ã“ã«ã‚¿ã‚¤ãƒ—ï¼">
  </div>
</div>
<div id="start-screen">
  <h1>ğŸ¤ ã²ã‚ˆã“ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ãƒãƒˆãƒ«</h1>
  <p>è¿«ã‚Šãã‚‹æ•µã‚’æ­£ã—ãã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã—ã¦å€’ãã†ï¼</p>
  <p class="hint">Escã‚­ãƒ¼ã§ã‚¿ãƒ¼ã‚²ãƒƒãƒˆåˆ‡ã‚Šæ›¿ãˆ / Backspaceã§ãƒŸã‚¹ä¿®æ­£</p>
  <button class="btn" id="start-btn">ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
</div>
<div id="gameover-screen" style="display:none;">
  <h2>GAME OVER</h2>
  <div class="final-score" id="final-score">0</div>
  <div class="stats" id="final-stats"></div>
  <div class="highscore-entry" id="hsEntry" style="display:none;">
    <p>ãƒ©ãƒ³ã‚­ãƒ³ã‚°å…¥ã‚Šï¼ ãªã¾ãˆã‚’å…¥åŠ›:</p>
    <input type="text" id="hsName" maxlength="15" placeholder="ãªã¾ãˆ" autocomplete="off">
    <button class="go-btn primary" id="hsSubmit">ã¨ã†ã‚ã</button>
  </div>
  <div class="submitted-msg" id="hsSubmitted" style="display:none;">ã¨ã†ã‚ãã—ã¾ã—ãŸï¼</div>
  <div>
    <button class="go-btn primary" id="retry-btn">ã‚‚ã†ã„ã¡ã©</button>
    <button class="go-btn secondary" id="goLeaderboard">ãƒ©ãƒ³ã‚­ãƒ³ã‚°</button>
  </div>
</div>

<!-- Leaderboard Overlay -->
<div class="lb-overlay" id="lbOverlay">
  <div class="lb-panel">
    <h2>ãƒ©ãƒ³ã‚­ãƒ³ã‚° TOP 20</h2>
    <div id="lbList"></div>
    <button class="go-btn secondary" id="lbClose" style="display:block;margin:1rem auto 0;">ã¨ã˜ã‚‹</button>
  </div>
</div>

<script>
// ============ WORDS ============
const WORDS = [
  // ===== Lv1 (çŸ­ã„å˜èª) =====
  {ja:'ã­ã“',roma:'neko'},{ja:'ã„ã¬',roma:'inu'},{ja:'ãã‚‰',roma:'sora'},
  {ja:'ã†ã¿',roma:'umi'},{ja:'ã‚„ã¾',roma:'yama'},{ja:'ã‹ãœ',roma:'kaze'},
  {ja:'ã»ã—',roma:'hoshi'},{ja:'ã¯ãª',roma:'hana'},{ja:'ã‚ã‚',roma:'ame'},
  {ja:'ã‚†ã',roma:'yuki'},{ja:'ã²ã‚ˆã“',roma:'hiyoko'},{ja:'ãŸã¾ã”',roma:'tamago'},
  {ja:'ã•ãã‚‰',roma:'sakura'},{ja:'ã¿ãš',roma:'mizu'},{ja:'ã¤ã',roma:'tsuki'},
  {ja:'ãã‚‚',roma:'kumo'},{ja:'ã‹ã‚',roma:'kawa'},{ja:'ã‚‚ã‚Š',roma:'mori'},
  {ja:'ã²ã‹ã‚Š',roma:'hikari'},{ja:'ã«ã˜',roma:'niji'},
  {ja:'ã„ãˆ',roma:'ie'},{ja:'ã‹ã•',roma:'kasa'},{ja:'ãã¤',roma:'kutsu'},
  {ja:'ã¾ã©',roma:'mado'},{ja:'ã„ã—',roma:'ishi'},{ja:'ã™ãª',roma:'suna'},
  {ja:'ã‚€ã—',roma:'mushi'},{ja:'ã¨ã‚Š',roma:'tori'},{ja:'ã•ã‹ãª',roma:'sakana'},
  {ja:'ãŠã‹ã—',roma:'okashi'},{ja:'ãã™ã‚Š',roma:'kusuri'},{ja:'ã¾ãã‚‰',roma:'makura'},
  {ja:'ã‹ãŒã¿',roma:'kagami'},{ja:'ãŸã‹ã‚‰',roma:'takara'},{ja:'ã‚ã•ã²',roma:'asahi'},

  // ===== Lv2 (ãµã¤ã†) =====
  {ja:'ã‚Šã‚“ã”',roma:'ringo'},{ja:'ã¶ã©ã†',roma:'budou'},{ja:'ã¿ã‹ã‚“',roma:'mikan'},
  {ja:'ãŸã„ã‚ˆã†',roma:'taiyou'},{ja:'ã§ã‚“ã‚',roma:'denwa'},{ja:'ãŒã£ã“ã†',roma:'gakkou'},
  {ja:'ã›ã‚“ã›ã„',roma:'sensei'},{ja:'ã¨ã‚‚ã ã¡',roma:'tomodachi'},{ja:'ãŠã‚“ãŒã',roma:'ongaku'},
  {ja:'ã˜ã¦ã‚“ã—ã‚ƒ',roma:'jitensha'},{ja:'ã—ã‚“ã¶ã‚“',roma:'shinbun'},{ja:'ã‘ã—ã”ã‚€',roma:'keshigomu'},
  {ja:'ãˆã‚“ã´ã¤',roma:'enpitsu'},{ja:'ã‹ã„ã‚‚ã®',roma:'kaimono'},{ja:'ã²ã“ã†ã',roma:'hikouki'},
  {ja:'ã§ã‚“ã—ã‚ƒ',roma:'densha'},{ja:'ã©ã†ã¶ã¤',roma:'doubutsu'},{ja:'ãã‚‡ã†ã‚Šã‚…ã†',roma:'kyouryuu'},
  {ja:'ãƒ‘ã‚½ã‚³ãƒ³',roma:'pasokon'},{ja:'ãƒ†ãƒ¬ãƒ“',roma:'terebi'},
  {ja:'ã‚ãŒã­',roma:'megane'},{ja:'ã‹ã°ã‚“',roma:'kaban'},{ja:'ãã‚‹ã¾',roma:'kuruma'},
  {ja:'ã†ã•ã',roma:'usagi'},{ja:'ãã¤ã­',roma:'kitsune'},{ja:'ãŸã¬ã',roma:'tanuki'},
  {ja:'ã™ãšã‚',roma:'suzume'},{ja:'ã‹ã‚',roma:'kame'},{ja:'ã„ã‚‹ã‹',roma:'iruka'},
  {ja:'ãƒ©ãƒ¼ãƒ¡ãƒ³',roma:'raamen'},{ja:'ã‚«ãƒ¬ãƒ¼',roma:'karee'},{ja:'ãŠã«ãã‚Š',roma:'onigiri'},
  {ja:'ã™ã„ã‹',roma:'suika'},{ja:'ã„ã¡ã”',roma:'ichigo'},{ja:'ãƒ¡ãƒ­ãƒ³',roma:'meron'},
  {ja:'ãƒãƒ¼ãƒˆ',roma:'nooto'},{ja:'ã¯ã•ã¿',roma:'hasami'},{ja:'ãµã†ã›ã‚“',roma:'fuusen'},
  {ja:'ã«ã‚“ã˜ã‚“',roma:'ninjin'},{ja:'ãŸã¾ã­ã',roma:'tamanegi'},
  // é–¢è¥¿å¼ãƒ»ãƒ¦ãƒ¼ãƒ¢ã‚¢
  {ja:'ãªã‚“ã§ã‚„ã­ã‚“',roma:'nandeyanen'},{ja:'ã»ã‚“ã¾ã«',roma:'honmani'},
  {ja:'ã‚ã‹ã‚“ã§',roma:'akande'},{ja:'ãŠã‚‚ã‚ã„',roma:'omoroi'},
  {ja:'ã—ã‚‰ã‚“ã‘ã©',roma:'shirankedo'},{ja:'ã‚ã£ã¡ã‚ƒ',roma:'meccha'},

  // ===== Lv3 (ã‚€ãšã‹ã—ã„) =====
  {ja:'ã—ã‚‡ã†ã¼ã†ã—ã‚ƒ',roma:'shoubousha'},{ja:'ã¡ã‚‡ã†ã¡ã‚‡ã†',roma:'chouchou'},
  {ja:'ã—ã‚“ã‹ã‚“ã›ã‚“',roma:'shinkansen'},{ja:'ãŸã‚“ã˜ã‚‡ã†ã³',roma:'tanjoubi'},
  {ja:'ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°',roma:'puroguramingu'},{ja:'ã ã„ãŒãã›ã„',roma:'daigakusei'},
  {ja:'ã¨ã—ã‚‡ã‹ã‚“',roma:'toshokan'},{ja:'ã³ã‚‡ã†ã„ã‚“',roma:'byouin'},
  {ja:'ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³',roma:'sumaatofon'},{ja:'ã‚³ãƒ³ãƒ“ãƒ‹ã‚¨ãƒ³ã‚¹',roma:'konbiniensu'},
  {ja:'ã¡ã‹ã¦ã¤',roma:'chikatetsu'},{ja:'ã‘ã„ã•ã¤ã‹ã‚“',roma:'keisatsukan'},
  {ja:'ãŠã‚‚ã„ã§',roma:'omoide'},{ja:'ã¼ã†ã‘ã‚“',roma:'bouken'},
  {ja:'ã‚„ãã«ã',roma:'yakiniku'},{ja:'ã‹ãã”ãŠã‚Š',roma:'kakigoori'},
  {ja:'ã†ã‚“ã©ã†ã‹ã„',roma:'undoukai'},{ja:'ã™ã„ããã‹ã‚“',roma:'suizokukan'},
  {ja:'ã‚†ã†ãˆã‚“ã¡',roma:'yuuenchi'},{ja:'ã¯ãã¶ã¤ã‹ã‚“',roma:'hakubutsukan'},
  {ja:'ã¡ã‚‡ãã‚“ã°ã“',roma:'chokinbako'},{ja:'ã‘ã„ãŸã„ã§ã‚“ã‚',roma:'keitaidenwa'},
  {ja:'ã“ã†ã“ã†ã›ã„',roma:'koukousei'},{ja:'ãŠã¾ã¤ã‚Š',roma:'omatsuri'},
  {ja:'ã‹ã¶ã¨ã‚€ã—',roma:'kabutomushi'},{ja:'ã‚¯ãƒªã‚¹ãƒã‚¹',roma:'kurisumasu'},
  {ja:'ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆ',roma:'intaanetto'},{ja:'ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼',roma:'hanbaagaa'},
  {ja:'ã‚¢ã‚¤ã‚¹ã‚¯ãƒªãƒ¼ãƒ ',roma:'aisukuriimu'},{ja:'ãƒãƒ§ã‚³ãƒ¬ãƒ¼ãƒˆ',roma:'chokoreeto'},
  {ja:'ã‚¨ãƒ¬ãƒ™ãƒ¼ã‚¿ãƒ¼',roma:'erebeetaa'},{ja:'ãƒˆãƒ©ãƒ³ãƒãƒªãƒ³',roma:'toranporin'},
  // é–¢è¥¿å¼ãƒ»ãƒ¦ãƒ¼ãƒ¢ã‚¢
  {ja:'ãã‚“ãªã‚ã»ãª',roma:'sonnaahona'},{ja:'ã„ã‘ãšã‚„ãªã‚',roma:'ikezuyanaa'},
  {ja:'ã¡ã‚ƒã†ã¡ã‚ƒã†',roma:'chauchau'},{ja:'ã‚‚ã†ã‹ã‚Šã¾ã£ã‹',roma:'moukarimakka'},
  {ja:'ã¼ã¡ã¼ã¡ã§ã‚“ãª',roma:'bochibochidenna'},{ja:'ã›ã‚„ã‹ã¦',roma:'seyakate'},

  // ===== Lv4 (çŸ­ã„æ–‡ç« ) =====
  {ja:'ã²ã‚ˆã“ ãŒã‚“ã°ã‚Œ',roma:'hiyokoganbare'},
  {ja:'ãã‚‡ã†ã¯ ã„ã„ã¦ã‚“ã',roma:'kyouhaiitenki'},
  {ja:'ãŠãªã‹ãŒ ã™ã„ãŸ',roma:'onakagasuita'},
  {ja:'ã•ãã‚‰ãŒ ã•ã„ãŸ',roma:'sakuragasaita'},
  {ja:'ã‚ã—ãŸã¯ ã‚„ã™ã¿',roma:'ashitahayasumi'},
  {ja:'ã­ã“ãŒ ã­ã¦ã„ã‚‹',roma:'nekoganeteiru'},
  {ja:'ãã‚‰ãŒ ãã‚Œã„',roma:'soragakirei'},
  {ja:'ãŒã‚“ã°ã‚ã†ãœ',roma:'ganbarouze'},
  {ja:'ãŸã®ã—ã„ ãªã¤',roma:'tanoshiinatsu'},
  {ja:'ã‚†ã‚ã‚’ ã‹ãªãˆã‚‹',roma:'yumewokanaeru'},
  {ja:'ã‚ã•ã”ã¯ã‚“ ãŸã¹ãŸ',roma:'asagohantabeta'},
  {ja:'ã„ã£ã—ã‚‡ã« ã‚ãã¼ã†',roma:'isshoniasobou'},
  {ja:'ã«ã‚ã« ã¯ãªãŒ ã•ã',roma:'niwanihanagasaku'},
  {ja:'ãã¨ã¯ ã•ã‚€ã„',roma:'sotohasamui'},
  {ja:'ã†ã¡ã« ã‹ãˆã‚ã†',roma:'uchinikaerou'},
  {ja:'ã»ã‚“ã‚’ ã‚ˆã‚‚ã†',roma:'honwoyomou'},
  {ja:'ã‚ã‚ãŒ ãµã£ã¦ããŸ',roma:'amegafuttekita'},
  {ja:'ãŠã‚„ã™ã¿ãªã•ã„',roma:'oyasuminasai'},
  {ja:'ãŸã„ã¸ã‚“ã  ã«ã’ã‚',roma:'taihendanigero'},
  {ja:'ãŠã¯ã‚ˆã† ã”ã–ã„ã¾ã™',roma:'ohayougozaimasu'},
  {ja:'ã‚ã‚ŠãŒã¨ã† ã”ã–ã„ã¾ã™',roma:'arigatougozaimasu'},
  {ja:'ã„ãŸã ãã¾ã™',roma:'itadakimasu'},
  {ja:'ã”ã¡ãã†ã•ã¾',roma:'gochisousama'},
  {ja:'ã—ã‚…ãã ã„ã‚’ ã‚„ã‚‹',roma:'shukudaiwoyaru'},
  {ja:'ã§ã‚“ãã‚’ ã‘ã™',roma:'denkiwokesu'},
  // é–¢è¥¿å¼ãƒ»ãƒ¦ãƒ¼ãƒ¢ã‚¢æ–‡ç« 
  {ja:'ãªã‚“ã§ã‚„ã­ã‚“ ãã‚Œ',roma:'nandeyannensore'},
  {ja:'ã»ã‚“ã¾ã« ã™ã”ã„ãª',roma:'honmanisugoina'},
  {ja:'ãŠãŠãã« ã¾ã„ã©',roma:'ookinimado'}, // intentionally simplified
  {ja:'ã—ã‚‰ã‚“ãŒãª ãã‚Œ',roma:'shiranganasore'},
  {ja:'ã‚¢ãƒ›ã¡ã‚ƒã„ã¾ã‚“ã­ã‚“',roma:'ahochaimannen'},
  {ja:'ãŠã‚‚ã‚ã™ãã¦ ã‚ã‚ãŸ',roma:'omorosugitewarota'},
  {ja:'ãã‚Œãª ã‚ã‹ã‚‹ã‚',roma:'sorenawakruwa'},
  {ja:'ã´ãˆã‚“ ã“ãˆã¦ ã±ãŠã‚“',roma:'pienkoeteipaon'},
  {ja:'ã‚„ã°ã„ ãŠãã‚Œã‚‹',roma:'yabaiokureru'},
  {ja:'ã­ã‚€ã„ ã‘ã© ãŒã‚“ã°ã‚‹',roma:'nemuikedoganbaru'},

  // ===== Lv5 (é•·ã„æ–‡ç« ) =====
  {ja:'ã²ã‚ˆã“ã¯ ã¤ã‚ˆããªã£ãŸ',roma:'hiyokohatsuyokunatta'},
  {ja:'ã«ã»ã‚“ã”ã‚’ ã‚Œã‚“ã—ã‚…ã†',roma:'nihongoworenshuu'},
  {ja:'ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã¯ ãŸã®ã—ã„',roma:'taipinguhatanoshii'},
  {ja:'ã¾ã„ã«ã¡ãŒ ã¼ã†ã‘ã‚“ã ',roma:'mainichigaboukenda'},
  {ja:'ã¦ãã‚’ ã‚„ã£ã¤ã‘ã‚',roma:'tekiwoyattsukero'},
  {ja:'ã¨ã‚‚ã ã¡ã¨ ã‚ãã¶',roma:'tomodachitoasobu'},
  {ja:'ãŠã„ã—ã„ ã”ã¯ã‚“ã‚’ ãŸã¹ã‚‹',roma:'oishiigohanwotaberu'},
  {ja:'ã‚¹ã‚³ã‚¢ã‚’ ã“ã†ã—ã‚“ã—ã‚ˆã†',roma:'sukoawokoushinshiyou'},
  {ja:'ã•ã„ãã‚‡ã†ã® ã²ã‚ˆã“',roma:'saikyounohiyoko'},
  {ja:'ã‚³ãƒ³ãƒœã‚’ ã¤ãªã’ã‚ˆã†',roma:'konbowotsunageyou'},
  {ja:'ã‚ãã‚‰ã‚ãŸã‚‰ ãã“ã§ ãŠã‚ã‚Š',roma:'akirametarasokodeowari'},
  {ja:'ãªã¤ã‚„ã™ã¿ã« ã†ã¿ã¸ ã„ã',roma:'natsuyasuminiumiheiku'},
  {ja:'ãã‚‡ã†ã® ã°ã‚“ã”ã¯ã‚“ã¯ ã‚«ãƒ¬ãƒ¼',roma:'kyounobangohanhakaree'},
  {ja:'ã¨ã—ã‚‡ã‹ã‚“ã§ ã»ã‚“ã‚’ ã‹ã‚Šã‚‹',roma:'toshokandehonwokariru'},
  {ja:'ãŠãŠããª ã«ã˜ãŒ ã§ãŸ',roma:'ookinanijigadeta'},
  {ja:'ã¯ã‚„ãŠãã¯ ã•ã‚“ã‚‚ã‚“ã® ã¨ã',roma:'hayaokihasanmonnotoku'},
  {ja:'ãœã‚“ã‚Šã‚‡ãã§ ã¯ã—ã‚Œ',roma:'zenryokudehashire'},
  {ja:'ãªã‹ã¾ã¨ ã¡ã‹ã‚‰ã‚’ ã‚ã‚ã›ã‚‹',roma:'nakamatochikarawoawaseru'},
  {ja:'ã—ã£ã±ã„ã¯ ã›ã„ã“ã†ã® ã‚‚ã¨',roma:'shippaihaseikounomoto'},
  {ja:'ã¾ã»ã†ã® ã“ã¨ã°ã§ ãŸãŸã‹ãˆ',roma:'mahounokotobadetatakae'},
  {ja:'ã²ã‚ˆã“ã¯ ã›ã‹ã„ã‚’ ã™ãã†',roma:'hiyokohasekaiwosukuu'},
  // é–¢è¥¿å¼ãƒ»ãƒ¦ãƒ¼ãƒ¢ã‚¢é•·æ–‡
  {ja:'ãªã‚“ã§ã‚„ã­ã‚“ ãŠã‹ã—ã„ã‚„ã‚',roma:'nandeyanenokasiiyaro'},
  {ja:'ã‚ã£ã¡ã‚ƒ ãˆãˆã‚„ã‚“ ãã‚Œ',roma:'mecchaeeyansore'},
  {ja:'ãŠã°ã¡ã‚ƒã‚“ã® ã‚ã‚ã¡ã‚ƒã‚“',roma:'obachannoamechan'},
  {ja:'ãŸã“ã‚„ãã¯ ã›ã„ã',roma:'takoyakihaseigi'},
  {ja:'ã¼ã‘ã¨ ã¤ã£ã“ã¿ã® ã³ãŒã',roma:'boketotsukkomibigaku'},// intentionally simplified
  {ja:'ãŠã“ã‚ ãŸã¹ã¦ ã’ã‚“ã ã‚‚ã‚Šã‚‚ã‚Š',roma:'okometabetegenkimorimori'},
  {ja:'ã²ã‚ˆã“ã® ã¡ã‹ã‚‰ã¯ ã‚€ã’ã‚“ã ã„',roma:'hiyokonochikarahamugendai'},
  {ja:'ã“ã“ã¾ã§ ããŸã‚‰ ã‚‚ã† ã‚„ã‚‹ã—ã‹ãªã„',roma:'kokomadekitaramouyarusikanai'},
];

const ENEMY_TYPES = [
  { name: 'slime',    color: '#44cc44', body: 'ğŸŸ¢', size: 36, points: 100 },
  { name: 'bat',      color: '#8855cc', body: 'ğŸ¦‡', size: 32, points: 120 },
  { name: 'skeleton', color: '#cccccc', body: 'ğŸ’€', size: 38, points: 150 },
  { name: 'ghost',    color: '#aaddff', body: 'ğŸ‘»', size: 40, points: 180 },
  { name: 'demon',    color: '#dd3333', body: 'ğŸ‘¹', size: 44, points: 250 },
  { name: 'boss',     color: '#ff4400', body: 'ğŸ‰', size: 56, points: 500 },
];

// ===== SKY THEMES =====
const SKY_THEMES = [
  // Lv1-2: æœ
  { top: '#4a90d9', mid: '#87CEEB', bot: '#b8e6b8', cloud: 'rgba(255,255,255,0.7)', groundTop: '#5da64a', groundMid: '#4a8a3a', groundBot: '#3a6a2a', grass: '#6dc45a', stars: false },
  // Lv3-4: æ˜¼
  { top: '#3a80cc', mid: '#6cb4e6', bot: '#a8d8a8', cloud: 'rgba(255,255,255,0.6)', groundTop: '#5a9a45', groundMid: '#488535', groundBot: '#386528', grass: '#68ba55', stars: false },
  // Lv5-6: å¤•æ–¹
  { top: '#c05a30', mid: '#e8945a', bot: '#d4a06a', cloud: 'rgba(255,200,150,0.5)', groundTop: '#6a6035', groundMid: '#554a28', groundBot: '#3d3520', grass: '#7a7040', stars: false },
  // Lv7-8: å¤•æš®ã‚Œ
  { top: '#2a1545', mid: '#6a2a6a', bot: '#c44a30', cloud: 'rgba(180,120,160,0.35)', groundTop: '#3a3040', groundMid: '#2a2030', groundBot: '#1a1020', grass: '#4a3a50', stars: true },
  // Lv9-10: å¤œ
  { top: '#0a0a2a', mid: '#101040', bot: '#1a1a50', cloud: 'rgba(60,60,100,0.25)', groundTop: '#1a2018', groundMid: '#101510', groundBot: '#080a08', grass: '#2a3528', stars: true },
];

// ============ STATE ============
let canvas, ctx, W, H;
let score, combo, maxCombo, life, level, wordsTyped, enemiesEscaped, missCount;
let enemies, particles, floatingTexts, chick;
let gameRunning, spawnTimer, spawnInterval, gameTime;
let grassOffset = 0;
let activeEnemy = null;
let starPositions = []; // å¤œç©ºã®æ˜Ÿ

function init() {
  canvas = document.getElementById('game-canvas');
  ctx = canvas.getContext('2d');
  resize();
  window.addEventListener('resize', resize);
  // æ˜Ÿã®ä½ç½®ã‚’ç”Ÿæˆ
  for (let i = 0; i < 80; i++) {
    starPositions.push({
      x: Math.random(), y: Math.random() * 0.6,
      size: 0.5 + Math.random() * 2,
      twinkle: Math.random() * Math.PI * 2,
    });
  }
}

function resize() {
  W = canvas.width = window.innerWidth;
  H = canvas.height = window.innerHeight;
}

// ============ GAME LIFECYCLE ============
function startGame() {
  score = 0; combo = 0; maxCombo = 0; life = 5; level = 1;
  wordsTyped = 0; enemiesEscaped = 0; missCount = 0; gameTime = 0;
  enemies = []; particles = []; floatingTexts = [];
  spawnInterval = 2800; spawnTimer = 0;
  gameRunning = true; activeEnemy = null;

  chick = { x: W / 2, y: H - 130, bobTime: 0, attacking: false, attackTimer: 0, targetX: 0, targetY: 0 };

  document.getElementById('start-screen').style.display = 'none';
  document.getElementById('gameover-screen').style.display = 'none';
  updateUI();

  const input = document.getElementById('type-input');
  input.value = '';
  input.focus();

  requestAnimationFrame(gameLoop);
}

// ============ LEADERBOARD ============
let leaderboard = [];
let scoreSubmitted = false;

async function fetchLeaderboard() {
  try {
    const res = await fetch('/api/typing-scores');
    if (res.ok) leaderboard = await res.json();
  } catch(e) {}
}

async function submitScore(name, finalScore, finalLevel) {
  try {
    const res = await fetch('/api/typing-scores', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, score: finalScore, level: finalLevel })
    });
    if (res.ok) {
      leaderboard = await res.json();
      scoreSubmitted = true;
    }
  } catch(e) {}
}

function isHighScore(s) {
  if (leaderboard.length < 20) return s > 0;
  return s > leaderboard[leaderboard.length - 1].score;
}

function showLeaderboardOverlay() {
  const list = document.getElementById('lbList');
  if (leaderboard.length === 0) {
    list.innerHTML = '<div class="lb-empty">ã¾ã ã‚¹ã‚³ã‚¢ãŒã‚ã‚Šã¾ã›ã‚“</div>';
  } else {
    list.innerHTML = leaderboard.slice(0, 20).map((e, i) => {
      const medal = i === 0 ? 'ğŸ‘‘' : i === 1 ? 'ğŸ¥ˆ' : i === 2 ? 'ğŸ¥‰' : `${i+1}.`;
      const levelText = e.level ? ` Lv.${e.level}` : '';
      return `<div class="lb-row ${i < 3 ? 'top3' : ''}"><span class="rank">${medal}</span><span class="name">${e.name}</span><span class="score">${e.score.toLocaleString()}${levelText}</span></div>`;
    }).join('');
  }
  document.getElementById('lbOverlay').classList.add('active');
}

fetchLeaderboard();

function gameOver() {
  gameRunning = false;
  activeEnemy = null;
  scoreSubmitted = false;
  fetchLeaderboard().then(() => {
    document.getElementById('final-score').textContent = score;
    document.getElementById('final-stats').innerHTML =
      `å€’ã—ãŸæ•µ: ${wordsTyped}ä½“<br>æœ€å¤§ã‚³ãƒ³ãƒœ: ${maxCombo}<br>ãƒŸã‚¹ã‚¿ã‚¤ãƒ—: ${missCount}å›<br>ãƒ¬ãƒ™ãƒ«: ${level}`;
    document.getElementById('hsEntry').style.display = isHighScore(score) ? 'block' : 'none';
    document.getElementById('hsSubmitted').style.display = 'none';
    document.getElementById('hsName').value = '';
    document.getElementById('gameover-screen').style.display = 'flex';
  });
}

// ============ SPAWNING ============
function spawnEnemy() {
  const wordPool = getWordPool();
  const entry = wordPool[Math.floor(Math.random() * wordPool.length)];

  let typeIdx = 0;
  const r = Math.random();
  if (level >= 8 && r < 0.08)       typeIdx = 5;
  else if (level >= 5 && r < 0.2)   typeIdx = 4;
  else if (level >= 4 && r < 0.35)  typeIdx = 3;
  else if (level >= 3 && r < 0.5)   typeIdx = 2;
  else if (level >= 2 && r < 0.6)   typeIdx = 1;

  const type = ENEMY_TYPES[typeIdx];
  const side = Math.random() < 0.5 ? 'left' : 'right';
  const x = side === 'left' ? -50 : W + 50;
  const targetY = H - 130 + (Math.random() * 40 - 20);
  const lenFactor = Math.max(0.5, 1 - (entry.roma.length - 4) * 0.03);
  const speed = (0.35 + level * 0.06 + Math.random() * 0.25) * lenFactor;

  enemies.push({
    x, y: 60 + Math.random() * (H * 0.35),
    targetX: chick.x + (Math.random() * 100 - 50),
    targetY, speed,
    ja: entry.ja, roma: entry.roma,
    typedStr: '', correctLen: 0, _lastLen: 0,
    type, side,
    wobble: Math.random() * Math.PI * 2,
    alive: true,
  });
}

function getWordPool() {
  if (level <= 2) return WORDS.slice(0, 35);
  if (level <= 4) return WORDS.slice(0, 81);
  if (level <= 6) return WORDS.slice(0, 119);
  if (level <= 8) return WORDS.slice(0, 155);
  return WORDS;
}

// ============ AUTO TARGET ============
function findClosestEnemy(exclude) {
  let best = null;
  let bestDist = Infinity;
  for (const e of enemies) {
    if (!e.alive || e === exclude) continue;
    const d = distTo(e, chick);
    if (d < bestDist) { bestDist = d; best = e; }
  }
  return best;
}

function autoSelectTarget() {
  if (activeEnemy && activeEnemy.alive) return; // already have target
  const e = findClosestEnemy(null);
  if (e) {
    activeEnemy = e;
    // reset input to match
    document.getElementById('type-input').value = '';
  }
}

function switchTarget() {
  const input = document.getElementById('type-input');
  // reset current target
  if (activeEnemy) {
    activeEnemy.typedStr = '';
    activeEnemy.correctLen = 0;
    activeEnemy._lastLen = 0;
  }
  const next = findClosestEnemy(activeEnemy);
  if (next) {
    activeEnemy = next;
  }
  input.value = '';
}

// ============ INPUT ============
document.addEventListener('DOMContentLoaded', () => {
  init();
  const input = document.getElementById('type-input');

  input.addEventListener('input', () => {
    if (!gameRunning) return;
    const val = input.value.toLowerCase();

    // å…¥åŠ›ãŒç©º â†’ reset
    if (!val) {
      if (activeEnemy) {
        activeEnemy.typedStr = '';
        activeEnemy.correctLen = 0;
        activeEnemy._lastLen = 0;
      }
      return;
    }

    if (!activeEnemy) return;

    activeEnemy.typedStr = val;

    // å…ˆé ­ã‹ã‚‰é€£ç¶šæ­£è§£æ•°
    let correct = 0;
    for (let i = 0; i < val.length && i < activeEnemy.roma.length; i++) {
      if (val[i] === activeEnemy.roma[i]) correct++;
      else break;
    }
    activeEnemy.correctLen = correct;

    // ãƒŸã‚¹ã‚«ã‚¦ãƒ³ãƒˆ
    const hasMiss = correct < val.length;
    if (hasMiss && val.length > activeEnemy._lastLen) {
      missCount++;
    }
    activeEnemy._lastLen = val.length;

    // å…¨æ–‡å­—æ­£è§£ã§æ’ƒç ´
    if (correct === activeEnemy.roma.length && val.length === activeEnemy.roma.length) {
      const defeated = activeEnemy;
      activeEnemy = null;
      input.value = '';
      defeatEnemy(defeated);
    }
  });

  // Escapeã§ã‚¿ãƒ¼ã‚²ãƒƒãƒˆåˆ‡ã‚Šæ›¿ãˆ
  document.addEventListener('keydown', (ev) => {
    if (!gameRunning) return;
    if (ev.key === 'Escape') {
      ev.preventDefault();
      switchTarget();
      return;
    }
    input.focus();
  });

  document.getElementById('start-btn').addEventListener('click', startGame);
  document.getElementById('retry-btn').addEventListener('click', startGame);
  document.addEventListener('click', () => { if (gameRunning) input.focus(); });

  document.getElementById('goLeaderboard').addEventListener('click', () => {
    showLeaderboardOverlay();
  });

  document.getElementById('hsSubmit').addEventListener('click', async () => {
    const nameEl = document.getElementById('hsName');
    const name = nameEl.value.trim();
    if (name.length > 0 && !scoreSubmitted) {
      await submitScore(name, score, level);
      document.getElementById('hsEntry').style.display = 'none';
      document.getElementById('hsSubmitted').style.display = 'block';
    }
  });

  document.getElementById('hsName').addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      e.preventDefault();
      document.getElementById('hsSubmit').click();
    }
  });

  document.getElementById('lbClose').addEventListener('click', () => {
    document.getElementById('lbOverlay').classList.remove('active');
  });
});

function distTo(a, b) {
  return Math.hypot(a.x - b.x, a.y - b.y);
}

function defeatEnemy(e) {
  e.alive = false;
  combo++;
  wordsTyped++;
  if (combo > maxCombo) maxCombo = combo;

  const comboMultiplier = 1 + Math.floor(combo / 5) * 0.5;
  const points = Math.floor(e.type.points * comboMultiplier);
  score += points;

  chick.attacking = true;
  chick.attackTimer = 20;
  chick.targetX = e.x;
  chick.targetY = e.y;

  for (let i = 0; i < 15; i++) {
    particles.push({
      x: e.x, y: e.y,
      vx: (Math.random() - 0.5) * 8, vy: (Math.random() - 0.5) * 8 - 2,
      life: 30 + Math.random() * 20, maxLife: 50,
      color: e.type.color, size: 3 + Math.random() * 5,
    });
  }
  for (let i = 0; i < 5; i++) {
    particles.push({
      x: e.x, y: e.y,
      vx: (Math.random() - 0.5) * 5, vy: -3 - Math.random() * 4,
      life: 40, maxLife: 40, color: '#FFD700', size: 6, star: true,
    });
  }

  floatingTexts.push({
    x: e.x, y: e.y - 30,
    text: `+${points}`, life: 60,
    color: combo >= 10 ? '#FF4500' : combo >= 5 ? '#FFD700' : '#FFF',
    size: combo >= 10 ? 28 : combo >= 5 ? 24 : 20,
  });

  updateUI();
  updateLevel();
}

function updateLevel() {
  const newLevel = Math.min(10, 1 + Math.floor(wordsTyped / 5));
  if (newLevel !== level) {
    level = newLevel;
    spawnInterval = Math.max(800, 2800 - level * 250);
    document.getElementById('level-display').textContent = `Lv.${level}`;
    floatingTexts.push({
      x: W / 2, y: H / 2 - 40,
      text: `LEVEL ${level}!`, life: 90, color: '#7FFF00', size: 40,
    });
  }
}

function updateUI() {
  document.getElementById('score').textContent = score;
  document.getElementById('life-bar').textContent = 'â¤ï¸'.repeat(Math.max(0, life));
  const comboEl = document.getElementById('combo-display');
  if (combo >= 3) {
    comboEl.textContent = `${combo} COMBO!`;
    comboEl.style.opacity = '1';
    comboEl.style.fontSize = Math.min(36, 22 + combo) + 'px';
  } else {
    comboEl.style.opacity = '0';
  }
}

// ============ GAME LOOP ============
let lastTime = 0;
function gameLoop(timestamp) {
  if (!gameRunning) return;
  const dt = Math.min(32, timestamp - (lastTime || timestamp));
  lastTime = timestamp;
  gameTime += dt;

  spawnTimer += dt;
  if (spawnTimer >= spawnInterval) { spawnTimer = 0; spawnEnemy(); }

  update(dt);
  draw();
  requestAnimationFrame(gameLoop);
}

// ============ UPDATE ============
function update(dt) {
  const speed = dt / 16;

  for (const e of enemies) {
    if (!e.alive) continue;
    e.wobble += 0.05 * speed;

    const dx = e.targetX - e.x;
    const dy = e.targetY - e.y;
    const d = Math.hypot(dx, dy);
    if (d > 5) {
      e.x += (dx / d) * e.speed * speed;
      e.y += (dy / d) * e.speed * speed;
    }

    if (d < 40) {
      if (e === activeEnemy) {
        activeEnemy = null;
        document.getElementById('type-input').value = '';
      }
      e.alive = false;
      life--;
      combo = 0;
      enemiesEscaped++;
      updateUI();

      canvas.classList.add('damage-flash');
      setTimeout(() => canvas.classList.remove('damage-flash'), 300);
      floatingTexts.push({
        x: chick.x, y: chick.y - 40,
        text: 'ãƒ€ãƒ¡ãƒ¼ã‚¸!', life: 60, color: '#FF0000', size: 24,
      });
      if (life <= 0) { gameOver(); return; }
    }
  }

  enemies = enemies.filter(e => e.alive);

  if (activeEnemy && !activeEnemy.alive) {
    activeEnemy = null;
    document.getElementById('type-input').value = '';
  }

  // è‡ªå‹•ã‚¿ãƒ¼ã‚²ãƒƒãƒˆé¸æŠ
  autoSelectTarget();

  for (const p of particles) {
    p.x += p.vx * speed; p.y += p.vy * speed;
    p.vy += 0.15 * speed; p.life -= speed;
  }
  particles = particles.filter(p => p.life > 0);

  for (const ft of floatingTexts) { ft.y -= 1.2 * speed; ft.life -= speed; }
  floatingTexts = floatingTexts.filter(ft => ft.life > 0);

  chick.bobTime += 0.06 * speed;
  if (chick.attacking) {
    chick.attackTimer -= speed;
    if (chick.attackTimer <= 0) chick.attacking = false;
  }
  grassOffset = (grassOffset + 0.3 * speed) % 40;
}

// ============ SKY THEME ============
function getSkyTheme() {
  const idx = Math.min(4, Math.floor((level - 1) / 2));
  return SKY_THEMES[idx];
}

// ============ DRAW ============
function draw() {
  const theme = getSkyTheme();

  // Sky
  const skyGrad = ctx.createLinearGradient(0, 0, 0, H);
  skyGrad.addColorStop(0, theme.top);
  skyGrad.addColorStop(0.6, theme.mid);
  skyGrad.addColorStop(1, theme.bot);
  ctx.fillStyle = skyGrad;
  ctx.fillRect(0, 0, W, H);

  // Stars (å¤œ)
  if (theme.stars) drawStars();

  drawClouds(theme);
  drawGround(theme);

  for (const e of enemies) { if (e.alive) drawEnemy(e); }

  for (const p of particles) {
    const alpha = Math.max(0, p.life / p.maxLife);
    ctx.globalAlpha = alpha;
    if (p.star) drawStarShape(p.x, p.y, p.size, p.color);
    else {
      ctx.fillStyle = p.color;
      ctx.beginPath(); ctx.arc(p.x, p.y, p.size * alpha, 0, Math.PI * 2); ctx.fill();
    }
    ctx.globalAlpha = 1;
  }

  drawChick();
  if (chick.attacking && chick.attackTimer > 10) drawAttackEffect();

  for (const ft of floatingTexts) {
    const alpha = Math.min(1, ft.life / 20);
    ctx.globalAlpha = alpha;
    ctx.fillStyle = ft.color;
    ctx.font = `bold ${ft.size}px 'Segoe UI', sans-serif`;
    ctx.textAlign = 'center';
    ctx.strokeStyle = 'rgba(0,0,0,0.5)';
    ctx.lineWidth = 3;
    ctx.strokeText(ft.text, ft.x, ft.y);
    ctx.fillText(ft.text, ft.x, ft.y);
    ctx.globalAlpha = 1;
  }
}

function drawStars() {
  const t = gameTime * 0.001;
  for (const s of starPositions) {
    const twinkle = 0.5 + 0.5 * Math.sin(t + s.twinkle);
    ctx.globalAlpha = twinkle * 0.9;
    ctx.fillStyle = '#ffffff';
    ctx.beginPath();
    ctx.arc(s.x * W, s.y * H, s.size, 0, Math.PI * 2);
    ctx.fill();
  }
  ctx.globalAlpha = 1;
}

function drawClouds(theme) {
  ctx.fillStyle = theme.cloud;
  const t = gameTime * 0.00005;
  for (let i = 0; i < 5; i++) {
    const cx = ((i * 320 + t * W * (0.5 + i * 0.2)) % (W + 200)) - 100;
    const cy = 60 + i * 50;
    ctx.beginPath(); ctx.ellipse(cx, cy, 80 + i * 10, 30, 0, 0, Math.PI * 2); ctx.fill();
    ctx.beginPath(); ctx.ellipse(cx + 40, cy - 10, 50, 25, 0, 0, Math.PI * 2); ctx.fill();
    ctx.beginPath(); ctx.ellipse(cx - 30, cy - 5, 55, 22, 0, 0, Math.PI * 2); ctx.fill();
  }
}

function drawGround(theme) {
  const groundY = H - 80;
  const groundGrad = ctx.createLinearGradient(0, groundY, 0, H);
  groundGrad.addColorStop(0, theme.groundTop);
  groundGrad.addColorStop(0.3, theme.groundMid);
  groundGrad.addColorStop(1, theme.groundBot);
  ctx.fillStyle = groundGrad;
  ctx.fillRect(0, groundY, W, 80);
  ctx.strokeStyle = theme.grass;
  ctx.lineWidth = 2;
  for (let x = -40 + (grassOffset % 40); x < W + 40; x += 20) {
    ctx.beginPath(); ctx.moveTo(x, groundY); ctx.quadraticCurveTo(x + 5, groundY - 15, x + 2, groundY - 22); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(x + 10, groundY); ctx.quadraticCurveTo(x + 14, groundY - 10, x + 8, groundY - 16); ctx.stroke();
  }
}

function drawEnemy(e) {
  const wobbleX = Math.sin(e.wobble) * 4;
  const wobbleY = Math.cos(e.wobble * 1.3) * 3;
  const ex = e.x + wobbleX;
  const ey = e.y + wobbleY;
  const isTarget = (e === activeEnemy);

  ctx.fillStyle = 'rgba(0,0,0,0.15)';
  ctx.beginPath();
  ctx.ellipse(ex, ey + e.type.size * 0.6, e.type.size * 0.5, 8, 0, 0, Math.PI * 2);
  ctx.fill();

  if (isTarget) { ctx.shadowColor = '#FFD700'; ctx.shadowBlur = 12; }

  ctx.font = `${e.type.size}px serif`;
  ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
  ctx.fillText(e.type.body, ex, ey);
  ctx.shadowBlur = 0;

  // ãƒ†ã‚­ã‚¹ãƒˆ
  const roma = e.roma;
  const ja = e.ja;
  const typed = e.typedStr || '';

  ctx.font = 'bold 16px "Hiragino Sans", "Noto Sans JP", sans-serif';
  const jaWidth = ctx.measureText(ja).width + 24;
  ctx.font = 'bold 17px monospace';
  const romaWidth = ctx.measureText(roma).width + 24;
  const displayRoma = typed.length > roma.length ? typed : roma;
  const displayWidth = ctx.measureText(displayRoma).width + 24;
  const boxWidth = Math.max(jaWidth, romaWidth, displayWidth);
  const boxHeight = 50;
  const boxX = ex - boxWidth / 2;
  const boxY = ey - e.type.size - boxHeight - 6;

  ctx.fillStyle = isTarget ? 'rgba(0,0,0,0.82)' : 'rgba(0,0,0,0.6)';
  if (isTarget) {
    ctx.strokeStyle = '#FFD700'; ctx.lineWidth = 2;
    roundRect(ctx, boxX, boxY, boxWidth, boxHeight, 10);
    ctx.fill(); ctx.stroke();
  } else {
    roundRect(ctx, boxX, boxY, boxWidth, boxHeight, 10);
    ctx.fill();
  }

  // Japanese
  ctx.font = 'bold 16px "Hiragino Sans", "Noto Sans JP", sans-serif';
  ctx.fillStyle = isTarget ? '#FFD700' : '#ddc870';
  ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
  ctx.fillText(ja, ex, boxY + 16);

  // Romaji 1æ–‡å­—ãšã¤
  ctx.font = 'bold 17px monospace';
  ctx.textBaseline = 'middle';
  const romaY = boxY + 37;

  if (typed.length > 0 && isTarget) {
    ctx.textAlign = 'left';
    const totalW = ctx.measureText(roma).width;
    let startX = ex - totalW / 2;
    for (let i = 0; i < roma.length; i++) {
      const ch = roma[i];
      if (i < typed.length) {
        ctx.fillStyle = (typed[i] === ch) ? '#7FFF00' : '#FF4444';
      } else {
        ctx.fillStyle = '#ffffff';
      }
      ctx.fillText(ch, startX, romaY);
      startX += ctx.measureText(ch).width;
    }
    if (typed.length > roma.length) {
      ctx.fillStyle = '#FF4444';
      ctx.fillText(typed.slice(roma.length), startX, romaY);
    }
  } else {
    ctx.fillStyle = isTarget ? '#ffffff' : '#bbbbbb';
    ctx.textAlign = 'center';
    ctx.fillText(roma, ex, romaY);
  }

  // Progress bar
  const progress = e.correctLen / roma.length;
  const barW = boxWidth - 8;
  const barH = 3;
  const barX = ex - barW / 2;
  const barY = boxY + boxHeight + 2;
  ctx.fillStyle = 'rgba(255,255,255,0.2)';
  ctx.fillRect(barX, barY, barW, barH);
  ctx.fillStyle = progress > 0 ? '#7FFF00' : 'rgba(255,255,255,0.1)';
  ctx.fillRect(barX, barY, barW * progress, barH);
}

function drawChick() {
  const cx = chick.x;
  const bobY = Math.sin(chick.bobTime) * 4;
  const cy = chick.y + bobY;

  ctx.fillStyle = 'rgba(0,0,0,0.15)';
  ctx.beginPath(); ctx.ellipse(cx, chick.y + 30, 22, 8, 0, 0, Math.PI * 2); ctx.fill();

  ctx.fillStyle = '#FFE44D';
  ctx.beginPath(); ctx.ellipse(cx, cy, 24, 26, 0, 0, Math.PI * 2); ctx.fill();
  ctx.fillStyle = '#FFF3A0';
  ctx.beginPath(); ctx.ellipse(cx, cy + 6, 16, 16, 0, 0, Math.PI * 2); ctx.fill();

  ctx.fillStyle = '#FFE44D';
  ctx.beginPath(); ctx.arc(cx, cy - 26, 18, 0, Math.PI * 2); ctx.fill();

  ctx.fillStyle = '#333';
  ctx.beginPath(); ctx.arc(cx - 7, cy - 29, 3.5, 0, Math.PI * 2); ctx.fill();
  ctx.beginPath(); ctx.arc(cx + 7, cy - 29, 3.5, 0, Math.PI * 2); ctx.fill();
  ctx.fillStyle = '#fff';
  ctx.beginPath(); ctx.arc(cx - 6, cy - 30, 1.5, 0, Math.PI * 2); ctx.fill();
  ctx.beginPath(); ctx.arc(cx + 8, cy - 30, 1.5, 0, Math.PI * 2); ctx.fill();

  ctx.fillStyle = '#FF8C00';
  ctx.beginPath(); ctx.moveTo(cx, cy - 24); ctx.lineTo(cx + 8, cy - 21); ctx.lineTo(cx, cy - 18); ctx.closePath(); ctx.fill();

  ctx.fillStyle = 'rgba(255,130,130,0.35)';
  ctx.beginPath(); ctx.ellipse(cx - 13, cy - 22, 5, 3.5, 0, 0, Math.PI * 2); ctx.fill();
  ctx.beginPath(); ctx.ellipse(cx + 13, cy - 22, 5, 3.5, 0, 0, Math.PI * 2); ctx.fill();

  ctx.fillStyle = '#FFD700';
  ctx.beginPath();
  ctx.moveTo(cx - 3, cy - 44); ctx.quadraticCurveTo(cx + 4, cy - 56, cx + 2, cy - 44);
  ctx.quadraticCurveTo(cx + 8, cy - 54, cx + 7, cy - 42); ctx.fill();

  const wingFlap = chick.attacking ? Math.sin(gameTime * 0.03) * 15 : Math.sin(chick.bobTime * 2) * 5;
  ctx.fillStyle = '#FFD54F';
  ctx.beginPath(); ctx.ellipse(cx - 24, cy - 2, 12, 8, -0.3 - wingFlap * 0.03, 0, Math.PI * 2); ctx.fill();
  ctx.beginPath(); ctx.ellipse(cx + 24, cy - 2, 12, 8, 0.3 + wingFlap * 0.03, 0, Math.PI * 2); ctx.fill();

  ctx.fillStyle = '#FF8C00';
  ctx.beginPath(); ctx.ellipse(cx - 10, cy + 25, 8, 4, -0.2, 0, Math.PI * 2); ctx.fill();
  ctx.beginPath(); ctx.ellipse(cx + 10, cy + 25, 8, 4, 0.2, 0, Math.PI * 2); ctx.fill();

  if (chick.attacking) {
    ctx.strokeStyle = '#333'; ctx.lineWidth = 2;
    ctx.beginPath(); ctx.moveTo(cx - 11, cy - 33); ctx.lineTo(cx - 3, cy - 31); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(cx + 11, cy - 33); ctx.lineTo(cx + 3, cy - 31); ctx.stroke();
  }
}

function drawAttackEffect() {
  const dx = chick.targetX - chick.x;
  const dy = chick.targetY - chick.y;
  const progress = 1 - (chick.attackTimer - 10) / 10;

  ctx.strokeStyle = '#FFD700';
  ctx.lineWidth = 4 + Math.sin(gameTime * 0.1) * 2;
  ctx.shadowColor = '#FFD700'; ctx.shadowBlur = 15;
  ctx.beginPath();
  ctx.moveTo(chick.x, chick.y - 26);
  ctx.lineTo(chick.x + dx * progress, chick.y - 26 + dy * progress);
  ctx.stroke();

  ctx.strokeStyle = '#FFF'; ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(chick.x, chick.y - 26);
  ctx.lineTo(chick.x + dx * progress, chick.y - 26 + dy * progress);
  ctx.stroke();
  ctx.shadowBlur = 0;
}

function drawStarShape(x, y, size, color) {
  ctx.fillStyle = color;
  ctx.beginPath();
  for (let i = 0; i < 5; i++) {
    const angle = (i * 4 * Math.PI) / 5 - Math.PI / 2;
    const method = i === 0 ? 'moveTo' : 'lineTo';
    ctx[method](x + Math.cos(angle) * size, y + Math.sin(angle) * size);
  }
  ctx.closePath(); ctx.fill();
}

function roundRect(ctx, x, y, w, h, r) {
  ctx.beginPath();
  ctx.moveTo(x + r, y);
  ctx.lineTo(x + w - r, y);
  ctx.quadraticCurveTo(x + w, y, x + w, y + r);
  ctx.lineTo(x + w, y + h - r);
  ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
  ctx.lineTo(x + r, y + h);
  ctx.quadraticCurveTo(x, y + h, x, y + h - r);
  ctx.lineTo(x, y + r);
  ctx.quadraticCurveTo(x, y, x + r, y);
  ctx.closePath();
}
</script>
</body>
</html>
